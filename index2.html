<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Learning Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./dist/tytus.js"></script>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
    <h1>Machine Learning Visualizer</h1>
    
    <input type="file" id="csvFileInput" accept=".csv">
    
    <select id="modelSelector" onchange="updateParameters()">
        <option value="">Seleccione un modelo</option>
        <option value="decisionTree">Árbol de Decisión</option>
        <option value="linearRegression">Regresión Lineal</option>
        <option value="polynomialRegression">Regresión Polinómica</option>
        <option value="clustering">Clustering</option>
    </select>

    <div id="parameters"></div>

    <button onclick="trainModel()">Entrenar</button>
    <button onclick="predictModel()">Predecir</button>
    <button onclick="showTrends()">Mostrar Tendencias</button>
    <button onclick="showPatterns()">Mostrar Patrones</button>
    
    <canvas id="chartContainer" style="width:100%; height:500px;"></canvas>

    <script>
        let data = [];
        let model;
        let chartInstance = null; // Variable global para almacenar la instancia del gráfico

        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById('csvFileInput').addEventListener('change', (event) => {
                const file = event.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    data = parseCSV(content);
                    updateVariableSelectors();
                };
                reader.readAsText(file);
            });
        });

        function parseCSV(content) {
            const rows = content.trim().split("\n").map(row => row.split(","));
            return rows.map(row => row.map(cell => cell.trim()));
        }

        function updateVariableSelectors() {
            const variableNames = data[0];
            const outputVariableSelector = document.getElementById('outputVariable');
            const xVariableSelector = document.getElementById('xVariable');
            const yVariableSelector = document.getElementById('yVariable');

            if (outputVariableSelector) {
                outputVariableSelector.innerHTML = '';
            }
            if (xVariableSelector) {
                xVariableSelector.innerHTML = '';
            }
            if (yVariableSelector) {
                yVariableSelector.innerHTML = '';
            }

            variableNames.forEach(variable => {
                if (outputVariableSelector) {
                    outputVariableSelector.innerHTML += `<option value="${variable}">${variable}</option>`;
                }
                if (xVariableSelector) {
                    xVariableSelector.innerHTML += `<option value="${variable}">${variable}</option>`;
                }
                if (yVariableSelector) {
                    yVariableSelector.innerHTML += `<option value="${variable}">${variable}</option>`;
                }
            });
        }

        function updateParameters() {
            const modelType = document.getElementById('modelSelector').value;
            const paramsDiv = document.getElementById('parameters');
            paramsDiv.innerHTML = '';

            if (modelType === 'decisionTree') {
                paramsDiv.innerHTML = `
                    <label>Variable de salida:</label>
                    <select id="outputVariable"></select>
                `;
            } else if (modelType === 'linearRegression' || modelType === 'polynomialRegression') {
                paramsDiv.innerHTML = `
                    <label>Variable de entrada (X):</label>
                    <select id="xVariable"></select>
                    <label>Variable de salida (Y):</label>
                    <select id="yVariable"></select>
                `;
                if (modelType === 'polynomialRegression') {
                    paramsDiv.innerHTML += `
                        <label>Grado del polinomio:</label>
                        <input type="number" id="polynomialDegree" min="1" value="2" placeholder="Grado del polinomio">
                    `;
                }
            } else if (modelType === 'clustering') {
                paramsDiv.innerHTML = `
                    <label>Número de clusters:</label>
                    <input type="number" id="numClusters" min="1" placeholder="Número de clusters">
                `;
            }
            updateVariableSelectors();
        }

        function trainModel() {
            const modelType = document.getElementById('modelSelector').value;
            if (modelType === 'decisionTree') {
                trainDecisionTree();
            } else if (modelType === 'linearRegression') {
                trainLinearRegression();
            } else if (modelType === 'polynomialRegression') {
                trainPolynomialRegression();
            } else if (modelType === 'clustering') {
                trainClustering();
            }
        }

        function trainDecisionTree() {
            const outputVar = document.getElementById("outputVariable").value;
            if (!outputVar) {
                alert("Por favor, selecciona una variable de salida.");
                return;
            }

            if (!data || data.length < 2) {
                alert("Los datos no están disponibles o el archivo CSV está vacío.");
                return;
            }

            const outputIndex = data[0].indexOf(outputVar);
            if (outputIndex === -1) {
                alert("La variable de salida no se encontró en los datos.");
                return;
            }

            const features = data.slice(1).map(row => {
                return row.filter((_, index) => index !== outputIndex);
            });

            const labels = data.slice(1).map(row => row[outputIndex]);

            if (features.length !== labels.length || features.length === 0) {
                alert("Las características y las etiquetas no tienen la misma longitud o están vacías.");
                return;
            }

            const featuresArray = features.map(row => {
                return row.map(value => {
                    return value === "" ? null : value;
                });
            });

            console.log("Características:", featuresArray);
            console.log("Etiquetas:", labels);

            try {
                model = new DecisionTreeID3(featuresArray, labels);
                model.train();
            } catch (error) {
                console.error("Error al entrenar el modelo:", error);
                alert("Error al entrenar el modelo: " + error.message);
                return;
            }

            visualizeDecisionTree(model.getRoot());
            alert("Modelo de Árbol de Decisión entrenado.");
        }

        function trainLinearRegression() {
            const xVar = document.getElementById("xVariable").value;
            const yVar = document.getElementById("yVariable").value;
            if (!xVar || !yVar) {
                alert("Por favor, selecciona variables de entrada y salida.");
                return;
            }

            const xIndex = data[0].indexOf(xVar);
            const yIndex = data[0].indexOf(yVar);
            if (xIndex === -1 || yIndex === -1) {
                alert("Una de las variables no se encontró en los datos.");
                return;
            }

            const xTrain = data.slice(1).map(row => parseFloat(row[xIndex]));
            const yTrain = data.slice(1).map(row => parseFloat(row[yIndex]));

            model = new LinearRegression();
            model.fit(xTrain, yTrain);

            visualizeLinearRegression(xTrain, yTrain);
        }

        function trainPolynomialRegression() {
            const xVar = document.getElementById("xVariable").value;
            const yVar = document.getElementById("yVariable").value;
            const degree = parseInt(document.getElementById("polynomialDegree").value);
            if (!xVar || !yVar) {
                alert("Por favor, selecciona variables de entrada y salida.");
                return;
            }

            const xIndex = data[0].indexOf(xVar);
            const yIndex = data[0].indexOf(yVar);
            if (xIndex === -1 || yIndex === -1) {
                alert("Una de las variables no se encontró en los datos.");
                return;
            }

            const xTrain = data.slice(1).map(row => parseFloat(row[xIndex]));
            const yTrain = data.slice(1).map(row => parseFloat(row[yIndex]));

            model = new PolynomialRegression();
            model.fit(xTrain, yTrain, degree);

            visualizePolynomialRegression(xTrain, yTrain, degree);
            alert("Modelo de Regresión Polinómica entrenado.");
        }

        function trainClustering() {
            const numClusters = parseInt(document.getElementById("numClusters").value, 10);
            if (!numClusters) {
                alert("Por favor, ingresa un número válido de clusters.");
                return;
            }

            // Extraer características para el clustering (todas las columnas excepto la variable de salida)
            const features = data.slice(1).map(row => row.map(value => parseFloat(value)));

            model = new KMeans(numClusters);
            model.fit(features); // Entrenar el modelo KMeans

            visualizeClusters(model.predict(features)); // Visualizar los clusters resultantes
            alert("Modelo de KMeans entrenado.");
        }

        function predictModel() {
            if (!model) {
                alert("No se ha entrenado ningún modelo.");
                return;
            }
            // Implementar lógica de predicción según el modelo entrenado
        }

        function showTrends() {
            // Implementar lógica para mostrar tendencias
        }

        function showPatterns() {
            // Implementar lógica para mostrar patrones
        }

        function visualizeDecisionTree(root) {
            // Implementar visualización del árbol de decisión usando la biblioteca de visualización
        }

        function visualizeLinearRegression(x, y) {
            const ctx = document.getElementById('chartContainer').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy(); // Destruir el gráfico anterior si existe
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: x,
                    datasets: [{
                        label: 'Datos Originales',
                        data: y,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'X'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Y'
                            }
                        }
                    }
                }
            });
        }

        function visualizePolynomialRegression(x, y, degree) {
            const ctx = document.getElementById('chartContainer').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy(); // Destruir el gráfico anterior si existe
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: x,
                    datasets: [{
                        label: 'Regresión Polinómica (Grado ' + degree + ')',
                        data: y,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'X'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Y'
                            }
                        }
                    }
                }
            });
        }

        function visualizeClusters(clusters) {
            // Implementar la visualización de clusters
            console.log("Clusters:", clusters);
            // Aquí puedes añadir lógica para visualizar los clusters en un gráfico.
        }
    </script>
</body>
</html>
